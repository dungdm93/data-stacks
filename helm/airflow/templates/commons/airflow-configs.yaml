{{- $airflow := .Values.airflow }}
{{- $core := (dict "core" dict | mergeOverwrite $airflow).core }}
{{- $celery := (dict "celery" dict | mergeOverwrite $airflow).celery }}
{{- $kubernetes := (dict "kubernetes" dict | mergeOverwrite $airflow).kubernetes }}
{{- $elasticsearch := (dict "elasticsearch" dict | mergeOverwrite $airflow).elasticsearch }}

{{- $_ := set $core "dags_folder" .Values.dags.path }}
{{- $_ := set $core "donot_pickle" .Values.dags.doNotPickle }}
{{- $_ := set $core "sql_alchemy_conn" (include "airflow.database" .) }}

{{- with .Values.logs -}}
{{- $logsUrl := urlParse .path }}
{{- $_ := set $core "logging_level" .level }}
{{- if include "airflow.logs.local" . }}
  {{- $_ := set $core "base_log_folder" $logsUrl.path }}
  {{- $_ := set $core "remote_logging" false }}
{{- else }}
  {{- $_ := set $core "remote_logging" true }}
  {{- $_ := set $core "remote_log_conn_id" .remoteConnId }}
  {{- if eq $logsUrl.scheme "es" }}
    {{- $_ := unset $core "remote_base_log_folder" }}
    {{- $_ := set $elasticsearch "host" $logsUrl.host }}
  {{- else if eq $logsUrl.scheme "wasbs" }}
    {{- $_ := set $core "remote_base_log_folder" "//TODO" }}
  {{- else }}
    {{- $_ := set $core "remote_base_log_folder" .path }}
  {{- end }}
{{- end }}
{{- end }}

{{- if eq $core.executor "CeleryExecutor" }}
  {{- $_ := set $celery "broker_url" (include "airflow.celeryBroker" .) }}
  {{- if not $celery.result_backend }}
    {{- $_ := set $celery "result_backend" (include "airflow.celeryResultBackend" .) }}
  {{- end }}
{{- end }}

{{- if eq $core.executor "KubernetesExecutor" }}
  {{- $worker := mergeOverwrite (deepCopy .Values.commons) .Values.worker -}}

  {{- $_ := set $kubernetes "in_cluster"                         true                     }}
  {{- $_ := set $kubernetes "namespace"                          .Release.Namespace       }}
  {{- $_ := set $kubernetes "worker_container_repository"        $worker.image.repository }}
  {{- $_ := set $kubernetes "worker_container_tag"               $worker.image.tag        }}
  {{- $_ := set $kubernetes "worker_container_image_pull_policy" .Values.imagePullPolicy  }}
  # image_pull_secrets

  {{- $_ := set $kubernetes "airflow_configmap" (printf "%s-configs" (include "airflow.fullname" .)) }}
  # env_from_configmap_ref
  # env_from_secret_ref

  # DAGs
  {{- if eq .Values.dags.fetcher "none" }}
    {{- $_ := set $kubernetes "dags_in_image" true }}
  {{- else if eq .Values.dags.fetcher "git" }}
    {{- $_ := set $kubernetes "dags_in_image" false }}
    {{- $gitsync := .Values.dags.git -}}

    {{- $_ := set $kubernetes "git_repo"    $gitsync.repo    }}
    {{- $_ := set $kubernetes "git_branch"  $gitsync.branch  }}
    {{- $_ := set $kubernetes "git_subpath" $gitsync.subpath }}

    {{- if $gitsync.auth.username }}
      {{- $_ := set $kubernetes "git_sync_credentials_secret" (printf "%s-gitsync" (include "airflow.fullname" .)) }}
    {{- else if $gitsync.auth.sshKey }}
      {{- $_ := set $kubernetes "git_ssh_key_secret_name" (printf "%s-gitsync" (include "airflow.fullname" .)) }}
    {{- else if $gitsync.auth.externalSshKeySecret.name }}
      {{- $_ := set $kubernetes "git_ssh_key_secret_name" $gitsync.auth.externalSshKeySecret.name }}
      {{- if not (eq ($gitsync.auth.externalSshKeySecret.key | default "gitSshKey") "gitSshKey")}}
        {{- fail "Custom externalSshKeySecret.key is not support by KubernetesExecutor yet" }}
      {{- end }}
    {{- end }}
  {{- else if eq .Values.dags.fetcher "mount" }}
    {{- $_ := set $kubernetes "dags_in_image" false }}
  {{- end }}
{{- end }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "airflow.fullname" . }}-configs
  labels:
    {{- include "airflow.labels" . | nindent 4 }}
data:
  airflow.cfg: |
{{- range $key, $value := $airflow }}
  {{- if $value }}
    [{{ $key }}]
    {{- range $elem, $elemVal := $value }}
    {{ $elem }} = {{ $elemVal }}
    {{- end }}
  {{- end }}
{{ end }}
